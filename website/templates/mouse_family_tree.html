{% extends 'base.html' %}
{% block content %}
    <title>Mouse Family Tree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .link {
            fill: none;
            stroke: #999;
            stroke-opacity: 0.6;
            marker-end: url(#arrowhead);
        }

        .node {
            stroke: #555;
            stroke-width: 1.5px;
        }

        .node circle {
            fill: #69b3a2;
        }

        .node text {
            font-size: 10px;
            text-anchor: start;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <h2>Family Tree of Mouse ID: {{ mouse.mouse_id }}</h2>
    <svg id="mySVG" width="100%" height="100%">
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                    refX="5" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#999" />
            </marker>
        </defs>
    </svg>
    
    <script>
        const nodes = {{ nodes|safe }};
        const links = {{ links|safe }};
        
        // Function to set the SVG dimensions
        function setSvgDimensions() {
            const svg = d3.select("#mySVG");
            const width = window.innerWidth; // Dynamic width based on window size
            const height = window.innerHeight; // Dynamic height based on window size
    
            svg.attr("width", width)
               .attr("height", height)
               .attr("viewBox", `0 0 ${width} ${height}`); // Set viewBox to match new dimensions
        }
    
        // Initial set up of SVG dimensions
        setSvgDimensions();
    
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink().id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-200))
            .force("center", d3.forceCenter(window.innerWidth / 2, window.innerHeight / 2));
    
        const svg = d3.select("#mySVG");
    
        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", "url(#arrowhead)"); // To add arrowheads to links
    
        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node");
    
        node.append("circle")
            .attr("r", 5)
            .attr("fill", "#69b3a2");
    
        node.append("text")
            .attr("dy", 3)
            .attr("x", 8)
            .text(d => d.label);
    
        simulation
            .nodes(nodes)
            .on("tick", ticked);
    
        simulation.force("link")
            .links(links);
    
        function ticked() {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
    
            node
                .attr("transform", d => `translate(${d.x}, ${d.y})`);
        }
    
        // Add event listener for window resize
        window.addEventListener("resize", () => {
            setSvgDimensions(); // Update dimensions on resize
            simulation.force("center").x(window.innerWidth / 2).y(window.innerHeight / 2); // Re-center
            simulation.alpha(1).restart(); // Restart simulation to re-position nodes
        });
    </script>

</body>
{% endblock %}
