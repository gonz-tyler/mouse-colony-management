{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h1>Genetic Tree for Mouse {{ mouse.mouse_id }} - Strain {{ mouse.strain }} - Tube ID {{ mouse.tube_id }}</h1>
    <div id="cy" style="width: 100%; height: 600px; border: 1px solid #ccc;"></div>

    <!-- Embed tree data in a script tag to avoid JavaScript parsing issues -->
    <script id="tree-data" type="application/json">
        {{ tree_data|safe }}
    </script>

    <!-- Cytoscape.js CDN -->
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script>
    // Parse the JSON directly from the script tag
    const treeData = JSON.parse(document.getElementById('tree-data').textContent);

    // Helper to flatten tree into nodes and edges for Cytoscape
    let nodes = [];
    let edges = [];
    let seen = new Set();

    function addNode(node, parentId = null) {
        // Use name as id (unique for this dataset)
        const nodeId = node.name;
        if (!seen.has(nodeId)) {
            nodes.push({ data: { id: nodeId, label: node.name, highlight: node.highlight, cycle: node.cycle } });
            seen.add(nodeId);
        }
        if (parentId) {
            edges.push({ data: { source: nodeId, target: parentId } });
        }
        if (node.children) {
            for (const child of node.children) {
                addNode(child, nodeId);
            }
        }
    }
    addNode(treeData);

    // Cytoscape rendering
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: { nodes, edges },
        layout: { name: 'breadthfirst', directed: true, padding: 10, animate: true },
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': ele => ele.data('cycle') ? 'red' : (ele.data('highlight') ? 'orange' : '#666'),
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'color': '#222',
                    'font-weight': ele => ele.data('highlight') ? 'bold' : 'normal',
                    'text-outline-width': 1,
                    'text-outline-color': '#fff',
                    'width': 30,
                    'height': 30
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 3,
                    'line-color': '#ccc',
                    'target-arrow-color': '#ccc',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier'
                }
            }
        ]
    });
    </script>
{% endblock %}
